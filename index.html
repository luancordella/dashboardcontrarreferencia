
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Contrarreferência - Completo</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Chart.js para os gráficos originais -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<!-- Plotly.js para os novos gráficos avançados (Sankey, Heatmap) -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<style>
body {
    font-family: 'Inter', sans-serif;
    background: #f1f5f9;
    color: #0f172a;
    min-height: 100vh;
}
/* O "glass-card" agora é um "dash-card" limpo e moderno */
.dash-card {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.05);
    border-radius: 1rem;
    transition: all 0.3s ease;
    position: relative;
}
.dash-card:hover {
    box-shadow: 0 6px 16px 0 rgba(0, 0, 0, 0.07);
}
.loader {
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-top: 4px solid #0d9488;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
/* Botões de filtro rápido */
.quick-filter {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    background: #ffffff;
    border: 1px solid #cbd5e1;
    color: #334155;
    font-weight: 600;
    padding: 0.55rem 1rem;
    border-radius: 999px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.03);
}
.quick-filter:hover {
    transform: translateY(-2px);
    border-color: #94a3b8;
}
.quick-filter.active {
    background: linear-gradient(135deg, #0d9488, #0284c7);
    color: #fff;
    border-color: transparent;
    box-shadow: 0 4px 15px 0 rgba(13, 148, 136, 0.25);
}
/* Chips de Status */
.status-chip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 90px;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    text-transform: uppercase;
}
/* Insight cards */
.insight-card {
    background: linear-gradient(135deg, rgba(13, 148, 136, 0.05), rgba(2, 132, 199, 0.05));
    border: 1px solid rgba(13, 148, 136, 0.1);
    border-radius: 1rem;
    padding: 1rem;
    transition: all 0.3s ease;
}
.insight-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.05);
}
/* Destaque superior do KPI */
.kpi-card {
    position: relative;
    overflow: hidden;
}
.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #0d9488, #0284c7);
}
.filter-panel {
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    max-height: 2000px;
    overflow: hidden;
}
.filter-panel.collapsed {
    max-height: 0;
    opacity: 0;
    margin-top: 0;
    margin-bottom: 0;
}
.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}
table {
    width: 100%;
    min-width: 980px;
    border-collapse: separate;
    border-spacing: 0;
}
thead th {
    position: sticky;
    top: 0;
    background: #f8fafc;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.04em;
    color: #0d9488;
}
tbody tr:nth-child(even) {
    background: rgba(13, 148, 136, 0.03);
}
tbody tr:hover {
    background: rgba(2, 132, 199, 0.07);
}
/* Gradiente de texto */
.gradient-text {
    background: linear-gradient(90deg, #0d9488, #0284c7);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    font-weight: 700;
}
/* Botões principais */
.main-btn, .toggle-btn, .fab {
    background: linear-gradient(135deg, #0d9488, #0284c7);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px 0 rgba(13, 148, 136, 0.2);
}
.main-btn:hover, .toggle-btn:hover, .fab:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px 0 rgba(13, 148, 136, 0.3);
}
.fab {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 0;
}

/* Tooltips e Botões de Info */
.info-btn, .expand-btn {
    position: absolute;
    bottom: 1rem;
    width: 24px;
    height: 24px;
    background: #f1f5f9;
    color: #64748b;
    border: none;
    border-radius: 50%;
    font-weight: 700;
    font-size: 0.75rem;
    transition: all 0.2s ease;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
}
.info-btn { right: 1rem; cursor: help; }
.expand-btn { right: 3rem; cursor: pointer; }
.info-btn:hover, .expand-btn:hover {
    background: #0d9488;
    color: #ffffff;
    transform: scale(1.1);
}
.info-tooltip {
    display: none;
    position: absolute;
    bottom: 2.5rem;
    right: 1rem;
    width: 300px;
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 0.75rem;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    padding: 1rem;
    z-index: 20;
    font-size: 0.875rem;
    color: #334155;
    line-height: 1.6;
}
.info-btn:hover + .info-tooltip,
.info-tooltip:hover {
    display: block;
}
.info-tooltip h5 {
    font-weight: 700;
    color: #0d9488;
    margin-bottom: 0.5rem;
}

/* Modal */
#chart-modal {
    transition: opacity 0.3s ease, visibility 0.3s ease;
    opacity: 0;
    visibility: hidden;
}
#chart-modal.show {
    opacity: 1;
    visibility: visible;
}

/* Plotly overrides para esconder barra de ferramentas intrusiva */
.js-plotly-plot .plotly .modebar {
    left: 0 !important;
    right: auto !important;
}
</style>
</head>
<body class="min-h-screen p-4 md:p-8">
<div class="container mx-auto max-w-7xl">
<!-- CABEÇALHO -->
<div class="dash-card p-6 md:p-8 mb-8">
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
<div>
<h1 class="text-4xl font-bold gradient-text mb-2">Dashboard Contrarreferência</h1>
<p class="text-gray-600">
Explore os dados, aplique filtros dinâmicos.
</p>
<p id="last-update" class="text-sm text-gray-500 mt-2"></p>
</div>
<button
id="reload-btn"
class="hidden main-btn px-6 py-3 rounded-xl font-semibold transition-all shadow-lg"
>
<i class="fas fa-sync-alt mr-2"></i>Recarregar
</button>
</div>
</div>

<!-- SEÇÃO DE INPUT DA URL -->
<div id="url-input-section" class="dash-card p-8 mb-8">
<h2 class="text-2xl font-bold gradient-text mb-2"><i class="fas fa-cog mr-2"></i>Configuração da fonte</h2>
<p class="text-sm text-gray-500 mb-6">
Cole a URL pública do Web App (Google Apps Script).
</p>
<div class="flex flex-col md:flex-row gap-4 mb-4">
<input
type="text"
id="sheet-url"
placeholder="Cole a URL do Web App aqui..."
class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:outline-none transition-colors"
value="https://script.google.com/macros/s/AKfycbw_Mkrf_drZMhH4L6tlxWz0gcpI--iW4WOVTpbsC2TOeHy6wybQWh2M8uG8tglnUIHhLQ/exec"
/>
<button
id="load-btn"
class="main-btn px-8 py-3 rounded-xl font-semibold transition-all shadow-lg"
>
<i class="fas fa-download mr-2"></i>Carregar dados
</button>
</div>
<button
id="debug-btn"
class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300 transition-all"
>
<i class="fas fa-tools mr-2"></i>Mostrar debug
</button>
<div id="debug-container" class="mt-4 hidden">
<div
id="debug-output"
class="bg-gray-900 text-gray-100 rounded-lg p-4 text-xs font-mono max-h-60 overflow-y-auto"
></div>
</div>
</div>

<!-- ESTADOS DE LOADING E ERRO -->
<div id="loading" class="dash-card p-12 text-center mb-8 hidden">
<div class="loader mx-auto mb-4"></div>
<p class="text-xl font-semibold text-gray-700">Carregando dados...</p>
<p class="text-gray-500 mt-2">Um instante, por favor.</p>
</div>

<div id="error" class="dash-card p-8 text-center text-white mb-8 hidden" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
<div class="text-5xl mb-4"><i class="fas fa-exclamation-triangle"></i></div>
<h2 class="text-2xl font-bold mb-4">Erro ao carregar</h2>
<p id="error-message" class="text-lg mb-6 opacity-90"></p>
<button onclick="location.reload()" class="bg-white text-red-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-all">
<i class="fas fa-redo mr-2"></i>Tentar novamente
</button>
</div>

<!-- CORPO DO DASHBOARD -->
<div id="dashboard" class="hidden">
<!-- PAINEL DE FILTROS -->
<div class="dash-card p-6 mb-8">
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
<div>
<h2 class="text-2xl font-bold gradient-text"><i class="fas fa-filter mr-2"></i>Filtros dinâmicos</h2>
<p class="text-gray-600 text-sm mt-1">
Ajuste o período, status, especialidades ou busque termos livres.
</p>
</div>
<button id="toggle-filters" class="toggle-btn">
<i class="fas fa-chevron-up mr-2" id="toggle-icon"></i>Ocultar filtros
</button>
</div>

<div id="filter-panel" class="filter-panel">
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
<div>
<label for="filter-start-date" class="block text-sm font-semibold text-gray-600 mb-1">Início do período</label>
<input type="date" id="filter-start-date" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:outline-none transition-colors" />
</div>
<div>
<label for="filter-end-date" class="block text-sm font-semibold text-gray-600 mb-1">Fim do período</label>
<input type="date" id="filter-end-date" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:outline-none transition-colors" />
</div>
<div class="md:col-span-2 xl:col-span-2">
<label for="filter-search" class="block text-sm font-semibold text-gray-600 mb-1">Busca rápida</label>
<input type="text" id="filter-search" placeholder="Paciente, médico, status..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:outline-none transition-colors" />
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
<div>
<label for="filter-status" class="block text-sm font-semibold text-gray-600 mb-2">Status</label>
<select id="filter-status" multiple class="w-full border-2 border-gray-300 rounded-lg bg-white text-sm h-40"></select>
</div>
<div>
<label for="filter-especialidade" class="block text-sm font-semibold text-gray-600 mb-2">Especialidade</label>
<select id="filter-especialidade" multiple class="w-full border-2 border-gray-300 rounded-lg bg-white text-sm h-40"></select>
</div>
</div>
<div class="flex flex-wrap items-center gap-3 mt-6">
<button id="quick-last-7" class="quick-filter"><i class="fas fa-clock mr-2"></i>Últimos 7 dias</button>
<button id="quick-last-30" class="quick-filter"><i class="fas fa-calendar-alt mr-2"></i>Últimos 30 dias</button>
<button id="quick-last-90" class="quick-filter"><i class="fas fa-chart-bar mr-2"></i>Últimos 90 dias</button>
<button id="quick-current-trimester" class="quick-filter"><i class="fas fa-folder-open mr-2"></i>Trimestre recente</button>
<div class="flex items-center gap-2 ml-auto">
<button id="reset-filters" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:border-teal-500">Limpar</button>
<button id="download-csv" class="px-4 py-2 bg-gradient-to-r from-emerald-500 to-cyan-500 text-white font-semibold rounded-lg shadow">Exportar CSV</button>
</div>
</div>
<div id="filter-chips" class="flex flex-wrap gap-2 mt-4 text-sm text-gray-600"></div>
</div>
</div>

<!-- KPIs (LINHA 1) -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
<div class="dash-card p-6 kpi-card">
<h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Total</h3>
<p id="kpi-total" class="text-4xl font-bold gradient-text mt-1">0</p>
<p class="text-xs text-gray-500 mt-3">Cobertura: <span id="kpi-total-percent">0%</span></p>
</div>
<div class="dash-card p-6 kpi-card">
<h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Média de dias pendentes</h3>
<p id="kpi-avg" class="text-4xl font-bold text-teal-700 mt-1">0</p>
</div>
<div class="dash-card p-6 kpi-card">
<h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Críticos</h3>
<p id="kpi-criticos" class="text-4xl font-bold text-red-600 mt-1">0</p>
<p class="text-xs text-gray-500 mt-3">Equivale a <span id="kpi-criticos-percent">0%</span></p>
</div>
<div class="dash-card p-6 kpi-card">
<h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Taxa de conclusão</h3>
<p id="kpi-taxa" class="text-4xl font-bold text-blue-600 mt-1">0%</p>
</div>
</div>

<!-- KPIs (LINHA 2) -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-10">
<div class="dash-card p-6 kpi-card">
<h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Mediana de dias</h3>
<p id="kpi-median" class="text-3xl font-bold gradient-text mt-1">0</p>
</div>
<div class="dash-card p-6 kpi-card">
<h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Maior tempo pendente</h3>
<p id="kpi-max" class="text-3xl font-bold gradient-text mt-1">0</p>
</div>
<div class="dash-card p-6 kpi-card">
<h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Tempo médio de conclusão</h3>
<p id="kpi-conclusao" class="text-3xl font-bold text-teal-700 mt-1">0</p>
</div>
<div class="dash-card p-6 kpi-card">
<h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Base Carregada</h3>
<p id="kpi-base-total" class="text-3xl font-bold gradient-text mt-1">0</p>
</div>
</div>

<!-- GRÁFICOS ORIGINAIS (Layout com 2 colunas) -->
<h2 class="text-2xl font-bold gradient-text mb-4 pl-2 border-l-4 border-sky-500">Indicadores Gerais</h2>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
<!-- Status -->
<div class="dash-card p-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text"><i class="fas fa-chart-pie mr-2"></i>Status dos atendimentos</h3>
</div>
<div class="chart-container">
<canvas id="status-chart"></canvas>
</div>
<button class="expand-btn" aria-label="Ampliar gráfico"><i class="fas fa-expand"></i></button>
<button class="info-btn" aria-label="Informações"><i class="fas fa-info"></i></button>
<div class="info-tooltip">
<h5>Status</h5> Distribuição percentual de todos os atendimentos filtrados.
</div>
</div>
<!-- Desfechos -->
<div class="dash-card p-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text"><i class="fas fa-tasks mr-2"></i>Desfechos</h3>
</div>
<div class="chart-container">
<canvas id="desfecho-chart"></canvas>
</div>
<button class="expand-btn" aria-label="Ampliar gráfico"><i class="fas fa-expand"></i></button>
<button class="info-btn" aria-label="Informações do gráfico de desfechos"><i class="fas fa-info"></i></button>
<div class="info-tooltip">
<h5>Desfechos</h5> Distribuição dos resultados finais (alta, aceito, obito etc.) dos atendimentos filtrados.
</div>
</div>
<!-- Especialidades -->
<div class="dash-card p-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text"><i class="fas fa-stethoscope mr-2"></i>Top especialidades</h3>
</div>
<div class="chart-container">
<canvas id="especialidade-chart"></canvas>
</div>
<button class="expand-btn" aria-label="Ampliar gráfico"><i class="fas fa-expand"></i></button>
<button class="info-btn" aria-label="Informações das especialidades"><i class="fas fa-info"></i></button>
<div class="info-tooltip">
<h5>Especialidades</h5> Top 10 especialidades com maior volume de atendimentos no período filtrado.
</div>
</div>
<!-- Pareto Médicos -->
<div class="dash-card p-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text"><i class="fas fa-user-md mr-2"></i>Pareto - médicos</h3>
</div>
<div class="chart-container">
<canvas id="pareto-chart"></canvas>
</div>
<button class="expand-btn" aria-label="Ampliar gráfico"><i class="fas fa-expand"></i></button>
<button class="info-btn" aria-label="Informações do Pareto"><i class="fas fa-info"></i></button>
<div class="info-tooltip">
<h5>Pareto</h5> Ordena médicos por volume e mostra percentual acumulado (regra 80/20) para identificar concentradores.
</div>
</div>
<!-- Evolução Diária -->
<div class="dash-card p-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text"><i class="fas fa-chart-line mr-2"></i>Evolução diária & Tendência</h3>
</div>
<div class="chart-container">
<canvas id="timeline-chart"></canvas>
</div>
<button class="expand-btn" aria-label="Ampliar gráfico"><i class="fas fa-expand"></i></button>
<button class="info-btn" aria-label="Informações da evolução diária"><i class="fas fa-info"></i></button>
<div class="info-tooltip">
<h5>Evolução diária</h5> Série temporal de atendimentos fechados por dia, com linha de tendência para indicar direção.
</div>
</div>
<!-- Distribuição Mensal -->
<div class="dash-card p-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text"><i class="fas fa-calendar-alt mr-2"></i>Distribuição mensal</h3>
</div>
<div class="chart-container">
<canvas id="monthly-chart"></canvas>
</div>
<button class="expand-btn" aria-label="Ampliar gráfico"><i class="fas fa-expand"></i></button>
<button class="info-btn" aria-label="Informações da distribuição mensal"><i class="fas fa-info"></i></button>
<div class="info-tooltip">
<h5>Mensal</h5> Volume consolidado por mês/ano para ver sazonalidade e tendência macro.
</div>
</div>

<!-- Trimestre -->
<div class="dash-card p-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text"><i class="fas fa-calendar-check mr-2"></i>Por Trimestre</h3>
</div>
<div class="chart-container">
<canvas id="quarter-chart"></canvas>
</div>
<button class="expand-btn" aria-label="Ampliar gráfico"><i class="fas fa-expand"></i></button>
<button class="info-btn" aria-label="Informações por trimestre"><i class="fas fa-info"></i></button>
<div class="info-tooltip">
<h5>Trimestre</h5> Distribuição dos atendimentos agrupados por trimestre civil.
</div>
</div>
<!-- Horário de Pico -->
<div class="dash-card p-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text"><i class="fas fa-clock mr-2"></i>Horário de Pico</h3>
</div>
<div class="chart-container">
<canvas id="hourly-chart"></canvas>
</div>
<button class="expand-btn" aria-label="Ampliar gráfico"><i class="fas fa-expand"></i></button>
<button class="info-btn" aria-label="Informações do horário de pico"><i class="fas fa-info"></i></button>
<div class="info-tooltip">
<h5>Horário de Pico</h5> Distribuição por hora do dia para identificar janelas com maior entrada de casos.
</div>
</div>
<!-- Tempo de Conclusão -->
<div class="dash-card p-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text"><i class="fas fa-hourglass-half mr-2"></i>Tempo de Conclusão</h3>
</div>
<div class="chart-container">
<canvas id="resolution-time-chart"></canvas>
</div>
<button class="expand-btn" aria-label="Ampliar gráfico"><i class="fas fa-expand"></i></button>
<button class="info-btn" aria-label="Informações do tempo de conclusão"><i class="fas fa-info"></i></button>
<div class="info-tooltip">
<h5>Tempo de conclusão</h5> Agrupa atendimentos concluídos por faixas de dias entre abertura e finalização.
</div>
</div>

<!-- Funil de Conversão -->
<div class="dash-card p-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text">
<i class="fas fa-filter mr-2"></i>Funil de Status
</h3>
</div>
<div class="chart-container" style="height: 300px;">
<canvas id="funnel-chart"></canvas>
</div>
<button class="expand-btn" aria-label="Ampliar gráfico"><i class="fas fa-expand"></i></button>
<button class="info-btn" aria-label="Informações do funil de status"><i class="fas fa-info"></i></button>
<div class="info-tooltip">
<h5>Funil</h5> Mostra a queda progressiva de volume do total filtrado até status normal, aceitos e concluídos/alta.
</div>
</div>

<!-- Dias Pendentes -->
<div class="dash-card p-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text">
<i class="fas fa-calendar-times mr-2"></i>Distribuição de Dias Pendentes
</h3>
</div>
<div class="chart-container" style="height: 300px;">
<canvas id="pending-days-chart"></canvas>
</div>
<button class="expand-btn" aria-label="Ampliar gráfico"><i class="fas fa-expand"></i></button>
<button class="info-btn" aria-label="Informações de dias pendentes"><i class="fas fa-info"></i></button>
<div class="info-tooltip">
<h5>Dias pendentes</h5> Distribuição em faixas de dias que os casos permanecem abertos ou aguardando.
</div>
</div>

<!-- Status por Especialidade -->
<div class="dash-card p-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text">
<i class="fas fa-signal mr-2"></i>Status por Especialidade
</h3>
</div>
<div class="chart-container" style="height: 300px;">
<canvas id="status-by-specialty-chart"></canvas>
</div>
<button class="expand-btn" aria-label="Ampliar gráfico"><i class="fas fa-expand"></i></button>
<button class="info-btn" aria-label="Informações de status por especialidade"><i class="fas fa-info"></i></button>
<div class="info-tooltip">
<h5>Status por especialidade</h5> Top 10 especialidades com quebra por status para ver gargalos específicos.
</div>
</div>

<!-- Quadrante Especialidades -->
<div class="dash-card p-6 lg:col-span-2">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text">
<i class="fas fa-bullseye mr-2"></i>Análise de Quadrante: Volume vs Efetividade
</h3>
</div>
<div class="chart-container" style="height: 400px;">
<canvas id="quadrant-chart"></canvas>
</div>
<button class="expand-btn" aria-label="Ampliar gráfico"><i class="fas fa-expand"></i></button>
<button class="info-btn" aria-label="Informações do gráfico"><i class="fas fa-info"></i></button>
<!-- Tooltip do quadrante -->
<div class="info-tooltip" id="quadrant-chart-tooltip">
<h5>Análise de Quadrante</h5>
<p class="mb-2"><strong>Eixo X (Volume):</strong> Total de atendimentos.</p>
<p class="mb-2"><strong>Eixo Y (Efetividade):</strong> % de desfechos positivos.</p>
</div>
</div>

</div>

<!-- [NOVO POSICIONAMENTO] SEÇÃO DE ANÁLISE AVANÇADA (Plotly) -->
<div class="mb-10">
    <h2 class="text-2xl font-bold gradient-text mb-4 pl-2 border-l-4 border-teal-500">Fluxos e Análise Avançada</h2>
    <p class="text-sm text-gray-500 mb-6 pl-2">Visualizações interativas adicionadas (Sankey, Heatmap, Treemap).</p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Sankey Chart -->
        <div class="dash-card p-6 lg:col-span-2">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-xl font-bold text-gray-700"><i class="fas fa-project-diagram mr-2 text-teal-600"></i>Fluxo de Atendimento (Sankey)</h3>
                    <p class="text-sm text-gray-500">Caminho completo: Especialidade → Desfecho → Status. Arraste os nós para reorganizar.</p>
                </div>
                <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded">Interativo</span>
            </div>
            <div id="sankey-chart" class="w-full min-h-[500px] h-[540px]"></div>
            <button class="expand-btn" aria-label="Ampliar gráfico Sankey"><i class="fas fa-expand"></i></button>
            <button class="info-btn" aria-label="Informações do Sankey"><i class="fas fa-info"></i></button>
            <div class="info-tooltip">
                <h5>Fluxo Sankey</h5>
                <p class="mb-2">Mostra o caminho dos casos das especialidades até o desfecho e depois o status. A largura da faixa representa o volume.</p>
                <p class="mb-0"><strong>Leia assim:</strong> comece na especialidade, siga até o desfecho e termine no status para ver perdas ou conversões.</p>
            </div>
        </div>

        <!-- Heatmap -->
        <div class="dash-card p-6 lg:col-span-2">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-xl font-bold text-gray-700"><i class="fas fa-th mr-2 text-sky-600"></i>Mapa de Calor: Ocupação</h3>
                    <p class="text-sm text-gray-500">Volume por dia da semana × hora do dia. Quanto mais escuro, maior o volume.</p>
                </div>
            </div>
            <div id="heatmap-chart" class="w-full min-h-[460px] h-[520px]"></div>
            <button class="expand-btn" aria-label="Ampliar mapa de calor"><i class="fas fa-expand"></i></button>
            <button class="info-btn" aria-label="Informações do mapa de calor"><i class="fas fa-info"></i></button>
            <div class="info-tooltip">
                <h5>Mapa de Calor</h5>
                <p class="mb-2">Identifica janelas de maior demanda ao cruzar dia da semana e horário.</p>
                <p class="mb-0"><strong>Dica:</strong> use para ajustar escalas e priorizar horários críticos.</p>
            </div>
        </div>

        <!-- Treemap -->
        <div class="dash-card p-6 lg:col-span-2">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-xl font-bold text-gray-700"><i class="fas fa-chart-area mr-2 text-indigo-600"></i>Volumetria (Treemap)</h3>
                    <p class="text-sm text-gray-500">Cada bloco representa uma especialidade; o tamanho é proporcional ao volume.</p>
                </div>
            </div>
            <div id="treemap-chart" class="w-full min-h-[460px] h-[520px]"></div>
            <button class="expand-btn" aria-label="Ampliar treemap"><i class="fas fa-expand"></i></button>
            <button class="info-btn" aria-label="Informações do treemap"><i class="fas fa-info"></i></button>
            <div class="info-tooltip">
                <h5>Treemap</h5>
                <p class="mb-2">Permite comparar rapidamente o peso de cada especialidade.</p>
                <p class="mb-0"><strong>Leia assim:</strong> blocos maiores indicam mais atendimentos; cores distinguem as especialidades.</p>
            </div>
        </div>
    </div>
</div>
<!-- [FIM DA SEÇÃO NOVA] -->

<!-- INSIGHTS E TABELA -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-12">
<div class="dash-card p-6 lg:col-span-1">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold gradient-text"><i class="fas fa-lightbulb mr-2"></i>Insights automáticos</h3>
</div>
<div id="insight-container" class="space-y-4">
<p class="text-sm text-gray-500">Carregue os dados para visualizar os principais destaques.</p>
</div>
</div>
<div class="dash-card p-6 lg:col-span-2">
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3 mb-4">
<div>
<h3 class="text-xl font-bold gradient-text"><i class="fas fa-table mr-2"></i>Registros filtrados</h3>
</div>
<span id="table-count" class="text-sm font-semibold text-teal-700 bg-teal-50 px-3 py-1 rounded-full">0 registros</span>
</div>

<input
type="text"
id="table-search"
placeholder="Buscar na tabela (refina os registros já filtrados)..."
class="mb-3 px-4 py-2 w-full border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:outline-none transition-colors"
/>

<div class="overflow-x-auto max-h-96 border border-gray-200 rounded-xl">
<table>
<thead>
<tr>
<th class="px-4 py-3 text-left">Atendimento</th>
<th class="px-4 py-3 text-left">Paciente</th>
<th class="px-4 py-3 text-left">Especialidade</th>
<th class="px-4 py-3 text-left">Médico</th>
<th class="px-4 py-3 text-left">Status</th>
<th class="px-4 py-3 text-left">Desfecho</th>
<th class="px-4 py-3 text-left">Data fechamento</th>
<th class="px-4 py-3 text-left">Data finalização</th>
<th class="px-4 py-3 text-left">Dias pendentes</th>
<th class="px-4 py-3 text-left">Observações</th>
</tr>
</thead>
<tbody id="detail-table-body"></tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<!-- Botão Flutuante para Topo -->
<div class="fab" id="fab-scroll-top" style="display: none;">
<i class="fas fa-arrow-up"></i>
</div>

<!-- Modal para Gráfico Ampliado -->
<div id="chart-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[2000] hidden items-center justify-center p-4" onclick="closeChartModal()">
<div class="dash-card w-full max-w-5xl h-[80vh] p-6" onclick="event.stopPropagation()">
<div class="flex justify-between items-center mb-4">
<h3 id="modal-chart-title" class="text-2xl font-bold gradient-text">Gráfico Ampliado</h3>
<button onclick="closeChartModal()" class="text-gray-500 hover:text-red-600 transition-colors text-2xl" aria-label="Fechar modal">&times;</button>
</div>
<div class="chart-container" style="height: calc(80vh - 100px);">
<canvas id="modal-chart-canvas"></canvas>
<div id="modal-plotly-container" class="hidden w-full h-full"></div>
</div>
</div>
</div>

<script>
const state = {
raw: [],
filtered: [],
charts: {
 modalChart: null, // Referência para o gráfico no modal (Chart.js)
 modalPlotly: null // Referência para o gráfico Plotly no modal
},
filters: { start: '', end: '', statuses: [], especialidades: [], search: '' },
meta: { statuses: [], especialidades: [], bounds: { min: null, max: null }, fetchedAt: null },
quick: null,
filterTimeout: null,
plotlyCache: {}
};

// Paleta de cores "hospitalar"
const chartPalette = [
'#14b8a6', // Teal-500
'#0284c7', // Sky-600
'#0e7490', // Cyan-700
'#22c55e', // Green-500
'#f59e0b', // Amber-500
'#ef4444', // Red-500
'#6b7280', // Gray-500
'#3b82f6' // Blue-500
];

const plotlyPalette = [
 '#0ea5e9', '#10b981', '#8b5cf6', '#f97316', '#ef4444',
 '#14b8a6', '#6366f1', '#22c55e', '#06b6d4', '#f59e0b',
 '#a855f7', '#e11d48'
];

const statusColors = {
'CRÍTICO': '#ef4444',
'ATENÇÃO': '#f59e0b',
'PENDENTE': '#3b82f6',
'NORMAL': '#0d9488',
'CONCLUÍDO': '#059669',
'OUTRO': '#6b7280'
};

const UI = {};

function hexToRgba(hex, alpha) {
const r = parseInt(hex.slice(1, 3), 16);
const g = parseInt(hex.slice(3, 5), 16);
const b = parseInt(hex.slice(5, 7), 16);
return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

document.addEventListener('DOMContentLoaded', () => {
assignDomRefs();
registerEvents();
if (UI.url?.value.trim()) loadDashboard();
});

function assignDomRefs() {
UI.load = document.getElementById('load-btn');
UI.reload = document.getElementById('reload-btn');
UI.url = document.getElementById('sheet-url');
UI.loading = document.getElementById('loading');
UI.error = document.getElementById('error');
UI.errorMessage = document.getElementById('error-message');
UI.dashboard = document.getElementById('dashboard');
UI.urlSection = document.getElementById('url-input-section');
UI.debugBtn = document.getElementById('debug-btn');
UI.debugBox = document.getElementById('debug-container');
UI.debugOutput = document.getElementById('debug-output');
UI.lastUpdate = document.getElementById('last-update');
UI.filterStart = document.getElementById('filter-start-date');
UI.filterEnd = document.getElementById('filter-end-date');
UI.filterStatus = document.getElementById('filter-status');
UI.filterEspecialidade = document.getElementById('filter-especialidade');
UI.filterSearch = document.getElementById('filter-search');
UI.filterChips = document.getElementById('filter-chips');
UI.resetFilters = document.getElementById('reset-filters');
UI.downloadCsv = document.getElementById('download-csv');
UI.tableBody = document.getElementById('detail-table-body');
UI.tableCount = document.getElementById('table-count');
UI.tableSearch = document.getElementById('table-search');
UI.insights = document.getElementById('insight-container');
UI.quickButtons = [
document.getElementById('quick-last-7'),
document.getElementById('quick-last-30'),
document.getElementById('quick-last-90'),
document.getElementById('quick-current-trimester')
].filter(Boolean);
UI.toggleFilters = document.getElementById('toggle-filters');
UI.filterPanel = document.getElementById('filter-panel');
UI.toggleIcon = document.getElementById('toggle-icon');
UI.fabScrollTop = document.getElementById('fab-scroll-top');
// Modal
UI.chartModal = document.getElementById('chart-modal');
UI.modalChartTitle = document.getElementById('modal-chart-title');
UI.modalChartCanvas = document.getElementById('modal-chart-canvas');
UI.modalPlotly = document.getElementById('modal-plotly-container');
}

function registerEvents() {
UI.load?.addEventListener('click', loadDashboard);
UI.reload?.addEventListener('click', loadDashboard);
UI.debugBtn?.addEventListener('click', () => {
if (!UI.debugBox) return;
UI.debugBox.classList.toggle('hidden');
});

UI.filterStart?.addEventListener('change', (event) => {
state.filters.start = event.target.value;
clearQuickSelection();
applyFilters();
});

UI.filterEnd?.addEventListener('change', (event) => {
state.filters.end = event.target.value;
clearQuickSelection();
applyFilters();
});

UI.filterSearch?.addEventListener('input', (event) => {
state.filters.search = event.target.value.trim().toLowerCase();
clearTimeout(state.filterTimeout);
state.filterTimeout = setTimeout(() => applyFilters(), 300);
});

UI.filterStatus?.addEventListener('change', () => {
state.filters.statuses = Array.from(UI.filterStatus.selectedOptions).map((option) => option.value);
clearQuickSelection();
applyFilters();
});

UI.filterEspecialidade?.addEventListener('change', () => {
state.filters.especialidades = Array.from(UI.filterEspecialidade.selectedOptions).map((option) => option.value);
clearQuickSelection();
applyFilters();
});

UI.quickButtons.forEach((button) => {
button.addEventListener('click', () => applyQuickFilter(button.id));
});

UI.resetFilters?.addEventListener('click', () => {
resetFilters();
applyFilters();
log('Filtros redefinidos.');
});

UI.downloadCsv?.addEventListener('click', exportCsv);

UI.toggleFilters?.addEventListener('click', () => {
UI.filterPanel.classList.toggle('collapsed');
const isCollapsed = UI.filterPanel.classList.contains('collapsed');
UI.toggleIcon.className = isCollapsed ? 'fas fa-chevron-down mr-2' : 'fas fa-chevron-up mr-2';
UI.toggleFilters.innerHTML = (isCollapsed ? '<i class="fas fa-chevron-down mr-2" id="toggle-icon"></i>Mostrar filtros' : '<i class="fas fa-chevron-up mr-2" id="toggle-icon"></i>Ocultar filtros');
});

UI.fabScrollTop?.addEventListener('click', () => {
window.scrollTo({ top: 0, behavior: 'smooth' });
});

window.addEventListener('scroll', () => {
if (window.scrollY > 300) {
UI.fabScrollTop.style.display = 'flex';
} else {
UI.fabScrollTop.style.display = 'none';
}
});

UI.tableSearch?.addEventListener('input', (e) => {
const term = e.target.value.toLowerCase();
if (!term) {
renderTable(state.filtered);
return;
}
const filteredForTable = state.filtered.filter(row =>
Object.values(row).some(val =>
String(val).toLowerCase().includes(term)
)
);
renderTable(filteredForTable);
});

// Evento para fechar modal ao pressionar 'Escape'
window.addEventListener('keydown', (e) => {
if (e.key === 'Escape' && UI.chartModal.classList.contains('show')) {
closeChartModal();
}
});
}

function openChartModal(chartInstance, title) {
if (!chartInstance) return;

if (state.charts.modalChart) {
state.charts.modalChart.destroy();
}
if (state.charts.modalPlotly && UI.modalPlotly && typeof Plotly !== 'undefined') {
Plotly.purge(UI.modalPlotly);
state.charts.modalPlotly = null;
}

UI.modalChartTitle.textContent = title;
if (UI.modalChartCanvas) UI.modalChartCanvas.classList.remove('hidden');
if (UI.modalPlotly) UI.modalPlotly.classList.add('hidden');
const config = chartInstance.config;
const modalOptions = JSON.parse(JSON.stringify(config.options)); // Deep clone
modalOptions.maintainAspectRatio = false;

state.charts.modalChart = new Chart(UI.modalChartCanvas, {
type: config.type,
data: config.data,
options: modalOptions
});

UI.chartModal.classList.remove('hidden');
setTimeout(() => UI.chartModal.classList.add('show'), 10);
}

function openPlotlyModal(cacheKey, title) {
const spec = state.plotlyCache[cacheKey];
if (!spec || !UI.modalPlotly || typeof Plotly === 'undefined') return;
if (state.charts.modalChart) {
state.charts.modalChart.destroy();
state.charts.modalChart = null;
}
UI.modalChartTitle.textContent = title;
if (UI.modalChartCanvas) UI.modalChartCanvas.classList.add('hidden');
UI.modalPlotly.classList.remove('hidden');
const containerHeight = UI.modalPlotly.parentElement ? UI.modalPlotly.parentElement.clientHeight : 600;
const layout = { ...spec.layout, height: containerHeight };
const config = { ...spec.config, displayModeBar: true };
Plotly.purge(UI.modalPlotly);
state.charts.modalPlotly = Plotly.react(UI.modalPlotly, spec.data, layout, config);
UI.chartModal.classList.remove('hidden');
setTimeout(() => UI.chartModal.classList.add('show'), 10);
}

function closeChartModal() {
UI.chartModal.classList.remove('show');
setTimeout(() => {
UI.chartModal.classList.add('hidden');
if (state.charts.modalChart) {
state.charts.modalChart.destroy();
state.charts.modalChart = null;
}
if (state.charts.modalPlotly && UI.modalPlotly && typeof Plotly !== 'undefined') {
Plotly.purge(UI.modalPlotly);
state.charts.modalPlotly = null;
}
if (UI.modalChartCanvas) UI.modalChartCanvas.classList.remove('hidden');
if (UI.modalPlotly) UI.modalPlotly.classList.add('hidden');
}, 300);
}

function loadDashboard() {
const url = UI.url?.value.trim();
if (!url) {
alert('Informe uma URL válida.');
return;
}

clearDebug();
log('Iniciando requisição...');

UI.loading?.classList.remove('hidden');
UI.urlSection?.classList.add('hidden');
UI.error?.classList.add('hidden');
UI.dashboard?.classList.add('hidden');

fetch(url)
.then((response) => {
if (!response.ok) throw new Error(`HTTP ${response.status} - ${response.statusText}`);
return response.json();
})
.then((data) => {
if (!Array.isArray(data) || !data.length) throw new Error('Resposta vazia ou inválida.');
log(`Dados recebidos: ${data.length} linhas.`);
const processed = processData(data);
setupDashboard(processed);
UI.loading?.classList.add('hidden');
UI.dashboard?.classList.remove('hidden');
UI.reload?.classList.remove('hidden');
log('Dashboard atualizado com sucesso.');
})
.catch((error) => {
UI.loading?.classList.add('hidden');
UI.error?.classList.remove('hidden');
UI.urlSection?.classList.remove('hidden');
if (UI.errorMessage) UI.errorMessage.textContent = error.message;
log(`Erro: ${error.message}`);
});
}

function processData(data) {
const rows = data
.map((row, index) => {
const desfecho = (row.DESFECHO || 'N/A').toString().trim().toUpperCase();
if (desfecho.includes('DUPLICADO')) return null;

const dataFechamento = parseDate(row.DATA_FECHAMENTO);
const dataFinalizacao = parseDate(row.DATA_FINALIZACAO);
let tempoConclusao = null;

if (dataFechamento && dataFinalizacao) {
const diff = dataFinalizacao.getTime() - dataFechamento.getTime();
if (diff >= 0) {
tempoConclusao = diff / (1000 * 60 * 60 * 24);
}
}

return {
ATENDIMENTO: (row.ATENDIMENTO || `AT${index + 1}`).toString().trim(),
RG: (row.RG || '').toString().trim(),
NOME_PACIENTE: (row.NOME_PACIENTE || 'N/A').toString().trim(),
DATA_FECHAMENTO: dataFechamento,
DATA_FECHAMENTO_RAW: row.DATA_FECHAMENTO || '',
HORA_FECHAMENTO_RAW: (row.HORA_FECHAMENTO || '').toString().trim(),
HORA: parseTime(row.HORA_FECHAMENTO),
MEDICO: (row.MEDICO || 'N/A').toString().trim(),
ESPECIALIDADE: (row.ESPECIALIDADE || 'N/A').toString().trim(),
DATA_FINALIZACAO: dataFinalizacao,
DATA_FINALIZACAO_RAW: row.DATA_FINALIZACAO || '',
DESFECHO: desfecho,
MES_ANO: (row.MES_ANO || '').toString().trim(),
TRIMESTRE: (row.TRIMESTRE || 'N/A').toString().trim(),
DIAS_PENDENTE: Number(row.DIAS_PENDENTE) || 0,
STATUS: (row.STATUS || 'N/A').toString().trim().toUpperCase(),
OBSERVACOES: (row.OBSERVACOES || '').toString().trim(),
TEMPO_CONCLUSAO: tempoConclusao
};
})
.filter(Boolean);

const statuses = Array.from(new Set(rows.map((row) => row.STATUS).filter(Boolean))).sort();
const especialidades = Array.from(new Set(rows.map((row) => row.ESPECIALIDADE).filter(Boolean))).sort((a, b) =>
a.localeCompare(b, 'pt-BR')
);

const dates = rows
.map((row) => row.DATA_FECHAMENTO)
.filter((date) => date instanceof Date && !Number.isNaN(date.getTime()));

return {
rows,
statuses,
especialidades,
bounds: {
min: dates.length ? new Date(Math.min(...dates)) : null,
max: dates.length ? new Date(Math.max(...dates)) : null
}
};
}

function setupDashboard(info) {
state.raw = info.rows;
state.filtered = info.rows.slice();
state.meta.statuses = info.statuses;
state.meta.especialidades = info.especialidades;
state.meta.bounds = info.bounds;
state.meta.fetchedAt = new Date();

populateFilters();
resetFilters();
applyFilters(true);
updateLastUpdate();
}

function populateFilters() {
if (UI.filterStatus) {
UI.filterStatus.innerHTML = state.meta.statuses
.map((status) => `<option value="${escapeHtml(status)}">${escapeHtml(status)}</option>`)
.join('');
}
if (UI.filterEspecialidade) {
UI.filterEspecialidade.innerHTML = state.meta.especialidades
.map((esp) => `<option value="${escapeHtml(esp)}">${escapeHtml(esp)}</option>`)
.join('');
}
}

function resetFilters() {
state.filters = { start: '', end: '', statuses: [], especialidades: [], search: '' };
state.quick = null;
if (UI.filterStart) UI.filterStart.value = '';
if (UI.filterEnd) UI.filterEnd.value = '';
if (UI.filterSearch) UI.filterSearch.value = '';
if (UI.tableSearch) UI.tableSearch.value = '';
if (UI.filterStatus) Array.from(UI.filterStatus.options).forEach((option) => (option.selected = false));
if (UI.filterEspecialidade)
Array.from(UI.filterEspecialidade.options).forEach((option) => (option.selected = false));
updateQuickButtons();
updateFilterChips();
}

function applyQuickFilter(id) {
if (!state.raw.length) return;
state.quick = id;
let end = new Date();
let start = null;

if (id === 'quick-last-7') start = shiftDays(end, 7);
else if (id === 'quick-last-30') start = shiftDays(end, 30);
else if (id === 'quick-last-90') start = shiftDays(end, 90);
else if (id === 'quick-current-trimester') {
const latestTrimester = state.raw
.map(r => r.TRIMESTRE)
.filter(t => t && t !== 'N/A')
.sort()
.pop();
if (latestTrimester) {
const sameTrimester = state.raw.filter(
(row) => row.TRIMESTRE === latestTrimester && row.DATA_FECHAMENTO instanceof Date
);
if (sameTrimester.length) {
start = new Date(Math.min(...sameTrimester.map((row) => row.DATA_FECHAMENTO)));
const maxTrimesterDate = new Date(Math.max(...sameTrimester.map((row) => row.DATA_FECHAMENTO)));
end = maxTrimesterDate > end ? end : maxTrimesterDate;
}
}
if (!start) start = shiftDays(end, 89);
}

if (start && end) {
if (UI.filterStart) UI.filterStart.value = toInputDate(start);
if (UI.filterEnd) UI.filterEnd.value = toInputDate(end);
state.filters.start = toInputDate(start);
state.filters.end = toInputDate(end);
}
updateQuickButtons();
applyFilters();
}

function updateQuickButtons() {
UI.quickButtons.forEach((button) => {
button.classList.toggle('active', button.id === state.quick);
});
}

function clearQuickSelection() {
state.quick = null;
updateQuickButtons();
}

function applyFilters(silent = false) {
if (!state.raw.length) return;
const { start, end, statuses, especialidades, search } = state.filters;
let rows = state.raw.slice();

if (start) {
const startDate = new Date(`${start}T00:00:00`);
rows = rows.filter((row) => !row.DATA_FECHAMENTO || row.DATA_FECHAMENTO >= startDate);
}
if (end) {
const endDate = new Date(`${end}T23:59:59`);
rows = rows.filter((row) => !row.DATA_FECHAMENTO || row.DATA_FECHAMENTO <= endDate);
}
if (statuses.length) rows = rows.filter((row) => statuses.includes(row.STATUS));
if (especialidades.length) rows = rows.filter((row) => especialidades.includes(row.ESPECIALIDADE));
if (search) {
rows = rows.filter((row) => {
const text = [
row.ATENDIMENTO,
row.NOME_PACIENTE,
row.MEDICO,
row.ESPECIALIDADE,
row.DESFECHO,
row.STATUS,
row.OBSERVACOES
].join(' ').toLowerCase();
return text.includes(search);
});
}

state.filtered = rows;
if (UI.tableSearch) UI.tableSearch.value = '';
updateFilterChips();
updateDashboard();
if (!silent) log(`Filtros aplicados: ${rows.length} de ${state.raw.length} registros.`);
}

function updateDashboard() {
const metrics = computeMetrics(state.filtered);
renderKPIs(metrics);
renderCharts(metrics);
renderPlotlyCharts(state.filtered); // Novo: Gráficos avançados
renderInsights(metrics);
renderTable(state.filtered);
updateLastUpdate();
}

function computeMetrics(rows) {
const total = rows.length;
const diasPendentes = rows.map((row) => row.DIAS_PENDENTE || 0);
const tempoConclusao = rows
.map((row) => row.TEMPO_CONCLUSAO)
.filter((value) => Number.isFinite(value) && value >= 0);

const totalDias = diasPendentes.reduce((sum, value) => sum + value, 0);
const avg = total ? totalDias / total : 0;
const median = diasPendentes.length ? medianValue(diasPendentes) : 0;
const maxDias = diasPendentes.length ? Math.max(...diasPendentes) : 0;
const tempoMedioConclusao = tempoConclusao.length
? tempoConclusao.reduce((sum, value) => sum + value, 0) / tempoConclusao.length
: 0;

const criticos = rows.filter((row) => {
const s = normalize(row.STATUS);
return s.includes('crit') || s.includes('aten');
}).length;

const concluidos = rows.filter((row) =>
['CONCLUIDO', 'CONCLUÍDO', 'FECHADO', 'ALTA', 'ACEITO', 'CDR', 'OBITO', 'ÓBITO', 'AGENDADO'].some((term) =>
row.DESFECHO.includes(term)
)
).length;

return {
kpis: {
total,
avg,
median,
maxDias,
criticos,
taxaConclusao: total ? (concluidos / total) * 100 : 0,
tempoMedioConclusao
},
statusData: aggregate(rows, 'STATUS'),
desfechoData: aggregate(rows, 'DESFECHO', 10),
especialidadeData: aggregate(rows, 'ESPECIALIDADE', 10),
medicoData: aggregate(rows, 'MEDICO', 10),
timelineData: aggregateTimeline(rows),
monthlyData: aggregateMonthly(rows),
quarterData: aggregateQuarterly(rows),
hourlyData: aggregateHourly(rows),
resolutionTimeData: aggregateResolutionTime(rows),
funnelData: aggregateFunnel(rows),
pendingDaysData: aggregatePendingDays(rows),
statusBySpecialtyData: aggregateStatusBySpecialty(rows)
};
}

function renderKPIs(metrics) {
const totalBase = state.raw.length || 1;
setText('kpi-total', formatNumber(metrics.kpis.total));
setText('kpi-total-percent', formatPercent(metrics.kpis.total, totalBase));
setText('kpi-avg', formatDecimal(metrics.kpis.avg));
setText('kpi-criticos', formatNumber(metrics.kpis.criticos));
setText('kpi-criticos-percent', formatPercent(metrics.kpis.criticos, metrics.kpis.total || 1));
setText('kpi-taxa', `${formatDecimal(metrics.kpis.taxaConclusao)}%`);
setText('kpi-median', formatDecimal(metrics.kpis.median));
setText('kpi-max', `${formatNumber(metrics.kpis.maxDias)} dias`);
setText('kpi-conclusao', formatDuration(metrics.kpis.tempoMedioConclusao));
setText('kpi-base-total', formatNumber(state.raw.length));
}

// --- PLOTLY CHARTS (NOVOS) ---
function renderPlotlyCharts(data) {
state.plotlyCache = {};
if (!data.length) return;

// 1. Sankey
const espCounts = {};
data.forEach(d => espCounts[d.ESPECIALIDADE] = (espCounts[d.ESPECIALIDADE] || 0) + 1);
const topEsp = Object.entries(espCounts).sort((a,b) => b[1] - a[1]).slice(0, 10).map(x => x[0]);

const nodes = [], nodeMap = new Map();
const getIdx = (n) => {
    if (!nodeMap.has(n)) { nodeMap.set(n, nodes.length); nodes.push(n); }
    return nodeMap.get(n);
};
const linkMap = new Map();
data.forEach(d => {
    const esp = topEsp.includes(d.ESPECIALIDADE) ? d.ESPECIALIDADE : 'OUTRAS';
    const desfecho = d.DESFECHO || 'N/A';
    const status = d.STATUS || 'N/A';
    [`${esp}|${desfecho}`, `${desfecho}|${status}`].forEach(k => linkMap.set(k, (linkMap.get(k) || 0) + 1));
});
const sources = [], targets = [], values = [], linkColors = [];
linkMap.forEach((v, k) => {
    const [s,t] = k.split('|');
    const sourceIdx = getIdx(s);
    const targetIdx = getIdx(t);
    sources.push(sourceIdx);
    targets.push(targetIdx);
    values.push(v);
    linkColors.push(hexToRgba(plotlyPalette[sourceIdx % plotlyPalette.length], 0.45));
});
const sankeyContainer = document.getElementById('sankey-chart');
const sankeyHeight = sankeyContainer ? sankeyContainer.clientHeight || 540 : 540;
const sankeyWidth = sankeyContainer ? sankeyContainer.clientWidth || 1100 : 1100;
const sankeySpec = {
    data: [{
        type: "sankey", orientation: "h",
        node: {
            pad: 15, thickness: 20, line: { color: "#e2e8f0", width: 1 }, label: nodes,
            color: nodes.map((_, i) => plotlyPalette[i % plotlyPalette.length])
        },
        link: { source: sources, target: targets, value: values, color: linkColors }
    }],
    layout: { margin: { l: 10, r: 10, t: 10, b: 10 }, height: sankeyHeight, width: sankeyWidth, autosize: true, font: {family:'Inter'}, paper_bgcolor:'#fff', plot_bgcolor:'#fff' },
    config: {displayModeBar: false, responsive: true, useResizeHandler: true}
};
state.plotlyCache.sankey = sankeySpec;
Plotly.react('sankey-chart', sankeySpec.data, sankeySpec.layout, sankeySpec.config);

// 2. Heatmap
const z = Array(7).fill(0).map(() => Array(24).fill(0));
data.forEach(d => {
    if (d.DATA_FECHAMENTO) {
        const h = d.HORA || 0;
        if (h >= 0 && h < 24) z[d.DATA_FECHAMENTO.getDay()][h]++;
    }
});
const heatmapContainer = document.getElementById('heatmap-chart');
const heatmapHeight = heatmapContainer ? heatmapContainer.clientHeight || 520 : 520;
const heatmapWidth = heatmapContainer ? heatmapContainer.clientWidth || 1100 : 1100;
const heatmapSpec = {
    data: [{
        z, x: Array.from({length:24},(_,i)=>i), y: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'],
        type: 'heatmap',
        colorscale: [[0, '#fff7ed'], [0.35, '#fdba74'], [0.7, '#fb923c'], [1, '#b91c1c']],
        hovertemplate: 'Dia %{y}<br>Hora %{x}:00<br>Qtd %{z}<extra></extra>'
    }],
    layout: { margin: {l:40, r:20, t:20, b:40}, height: heatmapHeight, width: heatmapWidth, autosize: true, xaxis: {title:'Hora'}, yaxis:{title:'Dia'}, font:{family:'Inter'} },
    config: {displayModeBar: false, responsive: true, useResizeHandler: true}
};
state.plotlyCache.heatmap = heatmapSpec;
Plotly.react('heatmap-chart', heatmapSpec.data, heatmapSpec.layout, heatmapSpec.config);

// 3. Treemap
const tCounts={}; data.forEach(d=>tCounts[d.ESPECIALIDADE]=(tCounts[d.ESPECIALIDADE]||0)+1);
const totalTreemap = Object.values(tCounts).reduce((a,b)=>a+b,0);
const tLabels = ["Total", ...Object.keys(tCounts)];
const tParents = ["", ...Object.keys(tCounts).map(()=>"Total")];
const tValues = [totalTreemap, ...Object.values(tCounts)];
const treemapColors = tLabels.map((_,i)=> i===0 ? '#cbd5e1' : plotlyPalette[(i-1)%plotlyPalette.length]);
const treemapContainer = document.getElementById('treemap-chart');
const treemapHeight = treemapContainer ? treemapContainer.clientHeight || 520 : 520;
const treemapWidth = treemapContainer ? treemapContainer.clientWidth || 1100 : 1100;
const treemapSpec = {
    data: [{
        type: "treemap", labels: tLabels, parents: tParents, values: tValues, branchvalues: "total",
        textinfo: "label+value", marker: {colors: treemapColors, line: {width: 1, color: '#fff'}},
        hovertemplate: '%{label}<br>Qtd: %{value}<extra></extra>'
    }],
    layout: { margin: {l:0, r:0, t:10, b:0}, height: treemapHeight, width: treemapWidth, autosize: true, font:{family:'Inter'} },
    config: {displayModeBar: false, responsive: true, useResizeHandler: true}
};
state.plotlyCache.treemap = treemapSpec;
Plotly.react('treemap-chart', treemapSpec.data, treemapSpec.layout, treemapSpec.config);

findAndAttachPlotlyExpand('sankey-chart', 'sankey', 'Fluxo de Atendimento (Sankey)');
findAndAttachPlotlyExpand('heatmap-chart', 'heatmap', 'Mapa de Calor: Ocupação');
findAndAttachPlotlyExpand('treemap-chart', 'treemap', 'Volumetria (Treemap)');
}

// --- CHART.JS ---
function renderCharts(metrics) {
destroyCharts();
state.charts.status = createDoughnut('status-chart', metrics.statusData, chartPalette);
state.charts.desfecho = createBar('desfecho-chart', metrics.desfechoData, chartPalette);
state.charts.especialidade = createBar('especialidade-chart', metrics.especialidadeData, [chartPalette[0]], 'y');
state.charts.pareto = createPareto('pareto-chart', metrics.medicoData);

const trendData = calculateLinearRegression(metrics.timelineData);
state.charts.timeline = createTimeline('timeline-chart', metrics.timelineData, trendData);

state.charts.monthly = createBar('monthly-chart', metrics.monthlyData, [chartPalette[2]]);
state.charts.quarter = createDoughnut('quarter-chart', metrics.quarterData, chartPalette.slice(0, 6));
state.charts.hourly = createLineChart('hourly-chart', metrics.hourlyData, chartPalette[1]);
state.charts.resolutionTime = createBar('resolution-time-chart', metrics.resolutionTimeData, [chartPalette[3]], 'x');
state.charts.funnel = createBar('funnel-chart', metrics.funnelData, chartPalette.slice(0, 4), 'y');
state.charts.pendingDays = createBar('pending-days-chart', metrics.pendingDaysData, [chartPalette[4]], 'x');
state.charts.statusBySpecialty = createStackedBar('status-by-specialty-chart', metrics.statusBySpecialtyData);

const quadrantData = aggregateSpecialtyQuadrant(state.filtered);
state.charts.quadrant = createQuadrantChart('quadrant-chart', quadrantData);

findAndAttachExpand('status-chart', 'status', 'Status dos atendimentos');
findAndAttachExpand('desfecho-chart', 'desfecho', 'Desfechos');
findAndAttachExpand('especialidade-chart', 'especialidade', 'Top especialidades');
findAndAttachExpand('pareto-chart', 'pareto', 'Pareto - médicos');
findAndAttachExpand('timeline-chart', 'timeline', 'Evolução diária & Tendência');
findAndAttachExpand('monthly-chart', 'monthly', 'Distribuição mensal');
findAndAttachExpand('quarter-chart', 'quarter', 'Por Trimestre');
findAndAttachExpand('hourly-chart', 'hourly', 'Horário de Pico');
findAndAttachExpand('resolution-time-chart', 'resolutionTime', 'Tempo de Conclusão');
findAndAttachExpand('quadrant-chart', 'quadrant', 'Análise de Quadrante');
findAndAttachExpand('funnel-chart', 'funnel', 'Funil de Status');
findAndAttachExpand('pending-days-chart', 'pendingDays', 'Distribuição de Dias Pendentes');
findAndAttachExpand('status-by-specialty-chart', 'statusBySpecialty', 'Status por Especialidade (Top 10)');
}

function findAndAttachExpand(canvasId, chartKey, title) {
const canvas = document.getElementById(canvasId);
if (!canvas) return;
const card = canvas.closest('.dash-card');
if (!card) return;
const expandBtn = card.querySelector('.expand-btn');
if (expandBtn) {
expandBtn.onclick = (e) => {
e.stopPropagation();
if (state.charts[chartKey]) {
openChartModal(state.charts[chartKey], title);
}
};
}
}

function findAndAttachPlotlyExpand(divId, cacheKey, title) {
const el = document.getElementById(divId);
if (!el) return;
const card = el.closest('.dash-card');
if (!card) return;
const expandBtn = card.querySelector('.expand-btn');
if (expandBtn) {
expandBtn.onclick = (e) => {
e.stopPropagation();
openPlotlyModal(cacheKey, title);
};
}
}

function renderInsights(metrics) {
if (!UI.insights) return;
const rows = state.filtered;
if (!rows.length) {
UI.insights.innerHTML = '<p class="text-sm text-gray-500">Nenhum registro com os filtros atuais.</p>';
return;
}

const insights = [];
const topStatus = metrics.statusData.labels[0];
const topStatusValue = metrics.statusData.values[0];
if (topStatus) {
insights.push({
title: 'Status predominante',
text: `${topStatus} responde por ${formatDecimal(calcPercent(topStatusValue, metrics.kpis.total || 1))}% dos registros.`
});
}

const topEspecialidade = metrics.especialidadeData.labels[0];
if (topEspecialidade) {
insights.push({
title: 'Especialidade mais acionada',
text: `${topEspecialidade} concentrou ${formatDecimal(
calcPercent(metrics.especialidadeData.values[0], metrics.kpis.total || 1)
)}% das solicitações.`
});
}

const peakHourData = metrics.hourlyData;
if (peakHourData && peakHourData.values.length) {
const peakValue = Math.max(...peakHourData.values);
const peakHourIndex = peakHourData.values.indexOf(peakValue);
const peakHourLabel = peakHourData.labels[peakHourIndex];
insights.push({
title: 'Horário de Pico',
text: `O maior volume de entradas ocorre às ${peakHourLabel}, com ${peakValue} registros.`
});
}

const maxRow = rows.reduce(
(prev, row) => (row.DIAS_PENDENTE > (prev?.DIAS_PENDENTE || 0) ? row : prev),
rows[0]
);
if (maxRow && maxRow.DIAS_PENDENTE) {
insights.push({
title: 'Maior tempo pendente',
text: `${maxRow.NOME_PACIENTE} acumula ${maxRow.DIAS_PENDENTE} dia(s) aguardando (${maxRow.ESPECIALIDADE}).`
});
}

UI.insights.innerHTML = insights.slice(0, 4).map(item => `
<article class="insight-card">
<h4 class="text-sm font-semibold text-teal-700">${escapeHtml(item.title)}</h4>
<p class="text-sm text-gray-700 mt-1">${escapeHtml(item.text)}</p>
</article>
`).join('');
}

function renderTable(rows) {
if (!UI.tableBody) return;
if (!rows.length) {
UI.tableBody.innerHTML = '<tr><td colspan="10" class="px-4 py-6 text-center text-sm text-gray-500">Nenhum registro encontrado.</td></tr>';
setText('table-count', '0 registros');
return;
}

const sorted = rows.slice().sort((a, b) => {
const timeA = a.DATA_FECHAMENTO ? a.DATA_FECHAMENTO.getTime() : 0;
const timeB = b.DATA_FECHAMENTO ? b.DATA_FECHAMENTO.getTime() : 0;
return timeB - timeA;
});

UI.tableBody.innerHTML = sorted.slice(0, 100).map((row) => {
const dataFechamento = row.DATA_FECHAMENTO
? `${formatDate(row.DATA_FECHAMENTO)}${row.HORA_FECHAMENTO_RAW ? ` ${row.HORA_FECHAMENTO_RAW}` : ''}`
: row.DATA_FECHAMENTO_RAW || '-';
const dataFinalizacao = row.DATA_FINALIZACAO ? formatDateTime(row.DATA_FINALIZACAO) : row.DATA_FINALIZACAO_RAW || '-';
return `
<tr>
<td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${escapeHtml(row.ATENDIMENTO)}</td>
<td class="px-4 py-3 text-sm text-gray-900 font-semibold min-w-[180px]">${escapeHtml(row.NOME_PACIENTE)}</td>
<td class="px-4 py-3 text-sm text-gray-700 min-w-[160px]">${escapeHtml(row.ESPECIALIDADE)}</td>
<td class="px-4 py-3 text-sm text-gray-700 min-w-[160px]">${escapeHtml(row.MEDICO)}</td>
<td class="px-4 py-3 text-sm text-gray-700">
<span class="${statusClass(row.STATUS)} status-chip">${escapeHtml(row.STATUS)}</span>
</td>
<td class="px-4 py-3 text-sm text-gray-700 min-w-[140px]">${escapeHtml(row.DESFECHO)}</td>
<td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${escapeHtml(dataFechamento)}</td>
<td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${escapeHtml(dataFinalizacao)}</td>
<td class="px-4 py-3 text-sm text-gray-700 text-center">${formatNumber(row.DIAS_PENDENTE || 0)}</td>
<td class="px-4 py-3 text-sm text-gray-600 min-w-[200px]" title="${escapeAttr(row.OBSERVACOES)}">
${escapeHtml(truncate(row.OBSERVACOES || '', 90)) || '-'}
</td>
</tr>
`;
}).join('');

setText('table-count', `${formatNumber(sorted.length)} registro(s)`);
}

function exportCsv() {
if (!state.filtered.length) {
alert('Não há registros para exportar.');
return;
}
const headers = [
'ATENDIMENTO', 'RG', 'NOME_PACIENTE', 'DATA_FECHAMENTO', 'HORA_FECHAMENTO',
'MEDICO', 'ESPECIALIDADE', 'DATA_FINALIZACAO', 'DESFECHO', 'MES_ANO',
'TRIMESTRE', 'DIAS_PENDENTE', 'STATUS', 'OBSERVACOES', 'TEMPO_CONCLUSAO_DIAS'
];
const rows = state.filtered.map((row) => [
row.ATENDIMENTO, row.RG, row.NOME_PACIENTE,
row.DATA_FECHAMENTO ? formatDate(row.DATA_FECHAMENTO) : row.DATA_FECHAMENTO_RAW,
row.HORA_FECHAMENTO_RAW, row.MEDICO, row.ESPECIALIDADE,
row.DATA_FINALIZACAO ? formatDateTime(row.DATA_FINALIZACAO) : row.DATA_FINALIZACAO_RAW,
row.DESFECHO, row.MES_ANO, row.TRIMESTRE, row.DIAS_PENDENTE, row.STATUS,
row.OBSERVACOES, row.TEMPO_CONCLUSAO !== null ? formatDecimal(row.TEMPO_CONCLUSAO) : ''
]);
const csv = [headers, ...rows].map(line => line.map(v => `"${String(v ?? '').replace(/"/g, '""')}"`).join(';')).join('\n');
const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
const url = URL.createObjectURL(blob);
const link = document.createElement('a');
link.href = url;
link.download = `dashboard-${toInputDate(new Date())}.csv`;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
URL.revokeObjectURL(url);
}

// --- Funções de Criação de Gráficos (RESTORED FULL) ---

function calculateLinearRegression(data) {
if (!data || data.length < 2) return null;
let n = 0, sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
const transformedData = data.map(point => ({ x: point.x.getTime(), y: point.y }));
transformedData.forEach(point => {
sumX += point.x; sumY += point.y; sumXY += point.x * point.y; sumXX += point.x * point.x; n++;
});
const denominator = (n * sumXX - sumX * sumX);
if (denominator === 0) return null;
const b = (n * sumXY - sumX * sumY) / denominator;
const a = (sumY - b * sumX) / n;
if (!isFinite(a) || !isFinite(b)) return null;
return [
{ x: new Date(transformedData[0].x), y: a + b * transformedData[0].x },
{ x: new Date(transformedData[n - 1].x), y: a + b * transformedData[n - 1].x }
];
}

function createDoughnut(id, data, colors) {
const canvas = document.getElementById(id);
if (!canvas) return null;
return new Chart(canvas, {
type: 'doughnut',
data: {
labels: data.labels,
datasets: [{
data: data.values,
backgroundColor: colors,
borderWidth: 2, borderColor: '#fff', hoverOffset: 4
}]
},
options: {
responsive: true, maintainAspectRatio: false, cutout: '62%',
plugins: { legend: { position: 'bottom', labels: { boxWidth: 16, padding: 16, font: { family: 'Inter' } } } }
}
});
}

function createBar(id, data, colors, indexAxis = 'x') {
const canvas = document.getElementById(id);
if (!canvas) return null;
return new Chart(canvas, {
type: 'bar',
data: {
labels: data.labels,
datasets: [{
data: data.values,
backgroundColor: colors.length === 1 ? colors[0] : colors.slice(0, data.labels.length),
borderRadius: 8, maxBarThickness: 48
}]
},
options: {
indexAxis, responsive: true, maintainAspectRatio: false,
plugins: { legend: { display: false } },
scales: {
x: { ticks: { autoSkip: false, maxRotation: indexAxis === 'x' ? 45 : 0, font: { family: 'Inter' } }, grid: { display: false } },
y: { beginAtZero: true, ticks: { font: { family: 'Inter' } }, grid: { color: '#e2e8f0', drawBorder: false } }
}
}
});
}

function createStackedBar(id, data) {
const canvas = document.getElementById(id);
if (!canvas) return null;
return new Chart(canvas, {
type: 'bar', data: data,
options: {
indexAxis: 'y', responsive: true, maintainAspectRatio: false,
plugins: { legend: { position: 'bottom', labels: { font: { family: 'Inter' } } } },
scales: {
x: { stacked: true, ticks: { font: { family: 'Inter' } }, grid: { color: '#e2e8f0', drawBorder: false } },
y: { stacked: true, ticks: { font: { family: 'Inter' } }, grid: { display: false } }
}
}
});
}

function createPareto(id, data) {
const canvas = document.getElementById(id);
if (!canvas) return null;
const total = data.values.reduce((sum, value) => sum + value, 0) || 1;
let acc = 0;
const percentages = data.values.map((value) => { acc += value; return (acc / total) * 100; });
return new Chart(canvas, {
type: 'bar',
data: {
labels: data.labels,
datasets: [
{ label: 'Qtd', data: data.values, backgroundColor: chartPalette[0], borderRadius: 8, yAxisID: 'y', order: 2 },
{ label: 'Acumulado %', data: percentages, type: 'line', borderColor: chartPalette[1], backgroundColor: hexToRgba(chartPalette[1], 0.1), yAxisID: 'y1', tension: 0.3, fill: true, order: 1 }
]
},
options: {
responsive: true, maintainAspectRatio: false,
interaction: { mode: 'index', intersect: false },
plugins: { legend: { position: 'bottom', labels: { font: { family: 'Inter' } } } },
scales: {
y: { beginAtZero: true, grid: { drawBorder: false } },
y1: { beginAtZero: true, max: 100, position: 'right', grid: { drawOnChartArea: false } },
x: { ticks: { autoSkip: false, maxRotation: 45 }, grid: { display: false } }
}
}
});
}

function createTimeline(id, data, trendData = null) {
const canvas = document.getElementById(id);
if (!canvas) return null;
const datasets = [{
label: 'Atendimentos', data, borderColor: chartPalette[0], backgroundColor: hexToRgba(chartPalette[0], 0.1),
fill: true, tension: 0.4, pointRadius: 3, pointBackgroundColor: chartPalette[0], pointBorderColor: '#fff', pointBorderWidth: 2
}];
if (trendData) {
datasets.push({
label: 'Tendência', data: trendData, type: 'line', borderColor: '#f97316', backgroundColor: 'transparent',
borderWidth: 2, borderDash: [5, 5], pointRadius: 0, fill: false, tension: 0
});
}
return new Chart(canvas, {
type: 'line', data: { datasets: datasets },
options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom' } } },
scales: {
x: { type: 'time', time: { unit: 'day', tooltipFormat: 'dd/MM/yyyy', displayFormats: { day: 'dd/MM' } }, grid: { color: '#e2e8f0', drawBorder: false } },
y: { beginAtZero: true, grid: { color: 'transparent', drawBorder: false } }
}
});
}

function createLineChart(id, data, color) {
const canvas = document.getElementById(id);
if (!canvas) return null;
return new Chart(canvas, {
type: 'line',
data: {
labels: data.labels,
datasets: [{
label: 'Atendimentos', data: data.values, borderColor: color, backgroundColor: hexToRgba(color, 0.1),
fill: true, tension: 0.4, pointRadius: 2, pointBackgroundColor: color, pointBorderColor: '#fff', pointBorderWidth: 1
}]
},
options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { autoSkip: true, maxTicks: 12 }, grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#e2e8f0', drawBorder: false } } } }
});
}

function createQuadrantChart(id, data) {
const canvas = document.getElementById(id);
if (!canvas) return null;
const avgX = data.length ? data.reduce((sum, p) => sum + p.x, 0) / data.length : 0;
const avgY = data.length ? data.reduce((sum, p) => sum + p.y, 0) / data.length : 0;
return new Chart(canvas, {
type: 'scatter',
data: {
datasets: [{
label: 'Especialidades', data: data,
backgroundColor: data.map(d => {
if (d.x >= avgX && d.y >= avgY) return hexToRgba(chartPalette[3], 0.7);
if (d.x >= avgX && d.y < avgY) return hexToRgba(chartPalette[4], 0.7);
if (d.x < avgX && d.y >= avgY) return hexToRgba(chartPalette[0], 0.7);
return hexToRgba(chartPalette[5], 0.7);
}),
pointRadius: data.map(d => Math.max(5, Math.sqrt(d.size) * 1.5))
}]
},
options: {
responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
scales: { x: { title: { display: true, text: 'Volume' } }, y: { title: { display: true, text: 'Efetividade (%)' }, min: 0, max: 100 } }
}
});
}

function destroyCharts() {
closeChartModal();
Object.keys(state.charts).forEach(key => {
if (key !== 'modalChart' && key !== 'modalPlotly' && state.charts[key] && typeof state.charts[key].destroy === 'function') {
state.charts[key].destroy();
}
state.charts[key] = null;
});
state.charts.modalChart = null;
state.charts.modalPlotly = null;
}

// --- Funções de Agregação ---
function aggregate(rows, key, limit = null) {
const counts = {};
rows.forEach((row) => { const value = row[key] || 'N/A'; counts[value] = (counts[value] || 0) + 1; });
let entries = Object.entries(counts).filter(([label]) => label && label !== 'N/A').sort((a, b) => b[1] - a[1]);
if (limit) entries = entries.slice(0, limit);
return { labels: entries.map((entry) => entry[0]), values: entries.map((entry) => entry[1]) };
}

function aggregateTimeline(rows) {
const counts = {};
rows.forEach((row) => {
if (row.DATA_FECHAMENTO) {
const key = row.DATA_FECHAMENTO.toISOString().split('T')[0];
counts[key] = (counts[key] || 0) + 1;
}
});
return Object.entries(counts).map(([date, value]) => ({ x: new Date(date), y: value })).sort((a, b) => a.x - b.x);
}

function aggregateMonthly(rows) {
const counts = {};
rows.forEach((row) => {
let label = row.MES_ANO;
if (!label && row.DATA_FECHAMENTO) label = `${String(row.DATA_FECHAMENTO.getMonth() + 1).padStart(2, '0')}/${row.DATA_FECHAMENTO.getFullYear()}`;
label = label || 'Sem mês';
counts[label] = (counts[label] || 0) + 1;
});
const result = { labels: [], values: [] };
Object.entries(counts).sort((a, b) => monthToDate(a[0]) - monthToDate(b[0])).forEach(([label, value]) => {
result.labels.push(label); result.values.push(value);
});
return result;
}

function aggregateQuarterly(rows) {
const counts = {};
rows.forEach((row) => { const value = row['TRIMESTRE'] || 'N/A'; counts[value] = (counts[value] || 0) + 1; });
let entries = Object.entries(counts).filter(([label]) => label && label !== 'N/A').sort((a, b) => a[0].localeCompare(b[0], 'pt-BR'));
return { labels: entries.map((entry) => entry[0]), values: entries.map((entry) => entry[1]) };
}

function aggregateHourly(rows) {
const counts = Array(24).fill(0);
rows.forEach((row) => { if (row.HORA !== null && row.HORA >= 0 && row.HORA <= 23) counts[row.HORA]++; });
return { labels: Array.from({ length: 24 }, (_, i) => `${String(i).padStart(2, '0')}:00`), values: counts };
}

function aggregateResolutionTime(rows) {
const bins = { '0-1 dia': 0, '2-7 dias': 0, '8-14 dias': 0, '15-30 dias': 0, '31+ dias': 0 };
const concluidos = rows.filter(row => row.TEMPO_CONCLUSAO !== null && row.TEMPO_CONCLUSAO >= 0);
concluidos.forEach(row => {
const dias = row.TEMPO_CONCLUSAO;
if (dias <= 1) bins['0-1 dia']++; else if (dias <= 7) bins['2-7 dias']++; else if (dias <= 14) bins['8-14 dias']++;
else if (dias <= 30) bins['15-30 dias']++; else bins['31+ dias']++;
});
return { labels: Object.keys(bins), values: Object.values(bins) };
}

function aggregatePendingDays(rows) {
const bins = { '0-7 dias': 0, '8-14 dias': 0, '15-30 dias': 0, '31-60 dias': 0, '61+ dias': 0 };
rows.forEach(row => {
const dias = row.DIAS_PENDENTE;
if (dias <= 7) bins['0-7 dias']++; else if (dias <= 14) bins['8-14 dias']++; else if (dias <= 30) bins['15-30 dias']++;
else if (dias <= 60) bins['31-60 dias']++; else bins['61+ dias']++;
});
return { labels: Object.keys(bins), values: Object.values(bins) };
}

function aggregateStatusBySpecialty(rows) {
const topEspecialidades = aggregate(rows, 'ESPECIALIDADE', 10).labels;
if (!topEspecialidades.length) return { labels: [], datasets: [] };
const allStatus = [...state.meta.statuses].sort((a, b) => a.localeCompare(b));
const datasets = allStatus.map(status => ({
label: status,
data: topEspecialidades.map(esp => rows.filter(r => r.ESPECIALIDADE === esp && r.STATUS === status).length),
backgroundColor: statusColors[status] || statusColors['OUTRO']
}));
return { labels: topEspecialidades, datasets: datasets };
}

function aggregateSpecialtyQuadrant(rows) {
const specialtyData = {};
rows.forEach(row => {
const esp = row.ESPECIALIDADE || 'N/A';
if (esp === 'N/A') return;
if (!specialtyData[esp]) specialtyData[esp] = { total: 0, positivos: 0 };
specialtyData[esp].total++;
const desfecho = row.DESFECHO.toUpperCase();
if (desfecho.includes('ACEITO') || desfecho.includes('CONCLU') || desfecho.includes('ALTA') || desfecho.includes('CDR')) specialtyData[esp].positivos++;
});
return Object.entries(specialtyData)
.map(([name, data]) => ({ x: data.total, y: (data.total > 0) ? (data.positivos / data.total) * 100 : 0, label: name, size: data.total }))
.filter(d => d.x >= 5);
}

function aggregateFunnel(rows) {
return {
labels: ['Total Filtrado', 'Status NORMAL', 'Desfecho ACEITO', 'Desfecho CONCLUÍDO/ALTA'],
values: [
    rows.length,
    rows.filter(r => (r.STATUS || '').toUpperCase() === 'NORMAL').length,
    rows.filter(r => (r.DESFECHO || '').toUpperCase().includes('ACEITO')).length,
    rows.filter(r => (r.DESFECHO || '').toUpperCase().includes('CONCLU') || (r.DESFECHO || '').toUpperCase().includes('ALTA')).length
]
};
}

function monthToDate(label) {
const [month, year] = label.split('/').map(Number);
if (!Number.isFinite(month) || !Number.isFinite(year)) return new Date(0);
return new Date(year, month - 1, 1);
}

// --- HELPERS (RESTAURADOS) ---

function parseDate(value) {
if (!value) return null;
if (value instanceof Date && !Number.isNaN(value.getTime())) return value;
const str = String(value).trim();
if (!str) return null;
let isoStr = str.replace(' ', 'T');
if (isoStr.length === 19) isoStr += 'Z';
const iso = new Date(isoStr);
if (!Number.isNaN(iso.getTime())) return iso;
const [datePart, timePart = '00:00:00'] = str.split(' ');
if (datePart.includes('/')) {
const [day, month, year] = datePart.split('/').map(Number);
const [hour = 0, minute = 0, second = 0] = timePart.split(':').map(Number);
if ([day, month, year].every(Number.isFinite) && year >= 1900) {
const parsed = new Date(year, month - 1, day, hour, minute, second);
if (!Number.isNaN(parsed.getTime())) return parsed;
}
}
return null;
}

function parseTime(timeStr) {
if (!timeStr) return null;
const parts = String(timeStr).split(':').map(Number);
if (parts.length > 0 && Number.isFinite(parts[0])) {
return parts[0];
}
return null;
}

function updateFilterChips() {
if (!UI.filterChips) return;
const chips = [];
if (state.filters.start || state.filters.end) {
const start = state.filters.start ? formatDate(new Date(`${state.filters.start}T00:00:00`)) : 'início';
const end = state.filters.end ? formatDate(new Date(`${state.filters.end}T00:00:00`)) : 'fim';
chips.push(`<span class="px-3 py-1 bg-teal-100 text-teal-700 rounded-full text-xs font-semibold">Período: ${escapeHtml(start)} → ${escapeHtml(end)}</span>`);
}
if (state.filters.statuses.length) chips.push(`<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">Status: ${escapeHtml(state.filters.statuses.join(', '))}</span>`);
if (state.filters.especialidades.length) chips.push(`<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">Espec: ${state.filters.especialidades.length} selecionadas</span>`);
if (state.filters.search) chips.push(`<span class="px-3 py-1 bg-sky-100 text-sky-700 rounded-full text-xs font-semibold">Busca: ${escapeHtml(state.filters.search)}</span>`);
UI.filterChips.innerHTML = chips.length ? chips.join('') : '<span class="text-xs text-gray-500">Nenhum filtro.</span>';
}

function updateLastUpdate() {
if (!UI.lastUpdate || !state.meta.fetchedAt) return;
const percent = formatPercent(state.filtered.length, state.raw.length || 1);
UI.lastUpdate.textContent = `Atualizado em ${formatDateTime(state.meta.fetchedAt)} • ${formatNumber(state.filtered.length)}/${formatNumber(state.raw.length)} (${percent}).`;
}

function setText(id, value) { const el = document.getElementById(id); if (el) el.textContent = value; }
function formatNumber(v) { return new Intl.NumberFormat('pt-BR').format(v || 0); }
function formatDecimal(v, d = 1) { return !Number.isFinite(v) ? '0,0' : v.toFixed(d).replace('.', ','); }
function calcPercent(p, t) { return !t ? 0 : (p / t) * 100; }
function formatPercent(p, t) { return `${formatDecimal(calcPercent(p, t))}%`; }
function formatDuration(d) { if (!Number.isFinite(d) || d <= 0) return 'N/D'; return d < 1 ? `${formatDecimal(d * 24)}h` : `${formatDecimal(d)} dias`; }
function formatDate(d) { return (!(d instanceof Date) || Number.isNaN(d.getTime())) ? '-' : d.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' }); }
function formatDateTime(d) { return (!(d instanceof Date) || Number.isNaN(d.getTime())) ? '-' : d.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short', timeZone: 'America/Sao_Paulo' }); }
function toInputDate(d) { if (!(d instanceof Date) || Number.isNaN(d.getTime())) return ''; const l = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)); return l.toISOString().split('T')[0]; }
function medianValue(v) { if (!v.length) return 0; const s = v.slice().sort((a, b) => a - b); const m = Math.floor(s.length / 2); return s.length % 2 === 0 ? (s[m - 1] + s[m]) / 2 : s[m]; }
function shiftDays(d, n) { const c = new Date(d); c.setDate(c.getDate() - n); return c; }
function truncate(t, l) { if (!t) return ''; return t.length <= l ? t : `${t.slice(0, l - 3)}...`; }
function statusClass(s) {
const n = normalize(s);
if (n.includes('crit')) return 'status-chip bg-red-100 text-red-700';
if (n.includes('aten')) return 'status-chip bg-yellow-100 text-yellow-700';
if (n.includes('pend')) return 'status-chip bg-blue-100 text-blue-700';
if (n.includes('neg')) return 'status-chip bg-gray-200 text-gray-700';
if (n.includes('normal')) return 'status-chip bg-teal-100 text-teal-700';
return 'status-chip bg-green-100 text-green-700';
}
function normalize(t) { return String(t || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase(); }
function escapeHtml(t) { return String(t || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }
function escapeAttr(t) { return escapeHtml(t).replace(/`/g, '&#96;'); }
function clearDebug() { if (UI.debugOutput) UI.debugOutput.innerHTML = ''; }
function log(m) {
const t = new Date().toLocaleTimeString();
const e = `[${t}] ${m}`;
console.log(e);
if (UI.debugOutput) { UI.debugOutput.innerHTML += `${escapeHtml(e)}<br />`; UI.debugOutput.scrollTop = UI.debugOutput.scrollHeight; }
}
</script>
</body>
</html>
